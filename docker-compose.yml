version: '3.8'

# With 256 cores, we can run 32 parallel instances!
# Each instance handles ~200k slots
# Total: 6.5M slots split across 32 instances

services:
  # Instance 1-8: First 1.6M slots
  data-collector-1:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=377107390
      - SLOT_END=377300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-2:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=377300000
      - SLOT_END=377500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-3:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=377500000
      - SLOT_END=377700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-4:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=377700000
      - SLOT_END=377900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-5:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=377900000
      - SLOT_END=378100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-6:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=378100000
      - SLOT_END=378300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-7:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=378300000
      - SLOT_END=378500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-8:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=378500000
      - SLOT_END=378700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  # Instance 9-16: Next 1.6M slots
  data-collector-9:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=378700000
      - SLOT_END=378900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-10:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=378900000
      - SLOT_END=379100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-11:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=379100000
      - SLOT_END=379300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-12:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=379300000
      - SLOT_END=379500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-13:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=379500000
      - SLOT_END=379700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-14:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=379700000
      - SLOT_END=379900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-15:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=379900000
      - SLOT_END=380100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-16:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=380100000
      - SLOT_END=380300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  # Instance 17-24: Next 1.6M slots
  data-collector-17:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=380300000
      - SLOT_END=380500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-18:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=380500000
      - SLOT_END=380700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-19:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=380700000
      - SLOT_END=380900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-20:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=380900000
      - SLOT_END=381100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-21:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=381100000
      - SLOT_END=381300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-22:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=381300000
      - SLOT_END=381500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-23:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=381500000
      - SLOT_END=381700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-24:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=381700000
      - SLOT_END=381900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  # Instance 25-32: Final 1.6M slots
  data-collector-25:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=381900000
      - SLOT_END=382100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-26:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=382100000
      - SLOT_END=382300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-27:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=382300000
      - SLOT_END=382500000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-28:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=382500000
      - SLOT_END=382700000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-29:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=382700000
      - SLOT_END=382900000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-30:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=382900000
      - SLOT_END=383100000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-31:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=383100000
      - SLOT_END=383300000
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  data-collector-32:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=383300000
      - SLOT_END=383639270
      - THREADS=8
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=false
      - CLEAR_DATA_AFTER=false
    depends_on:
      - clickhouse
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse-users.xml:/etc/clickhouse-server/users.d/default-password.xml
    environment:
      - CLICKHOUSE_DB=default
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    # Increase resources for high-throughput writes
    deploy:
      resources:
        limits:
          memory: 512G
        reservations:
          memory: 256G

volumes:
  clickhouse_data:
