# Simple test setup: ClickHouse + one collector
services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_test_data:/var/lib/clickhouse
      - ./clickhouse-users.xml:/etc/clickhouse-server/users.d/default-password.xml
    environment:
      - CLICKHOUSE_DB=default
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  collector:
    image: solixdb-collector:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SLOT_START=${SLOT_START:-377107390}
      - SLOT_END=${SLOT_END:-377108390}
      - THREADS=${THREADS:-10}
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NETWORK=mainnet
      - CLEAR_DB_ON_START=${CLEAR_DB_ON_START:-true}
      - CLEAR_DATA_AFTER=${CLEAR_DATA_AFTER:-false}
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

volumes:
  clickhouse_test_data:

